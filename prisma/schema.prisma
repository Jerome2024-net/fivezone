// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  name      String?
  email     String    @unique
  password  String
  role      String    @default("USER")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  reviews   Review[]
  businesses Business[]
  bookings   Booking[]
  sentMissionRequests     MissionRequest[] @relation("ClientMissions")
  receivedMissionRequests MissionRequest[] @relation("FreelanceMissions")
  paymentsMade            Payment[]        @relation("Payer")
  disputesFounded         Dispute[]
}

model Business {
  id          String    @id @default(cuid())
  name        String
  description String?
  address     String
  city        String
  country     String    @default("France")
  phone       String?
  website     String?
  imageUrl    String?
  coverUrl    String?
  rating      Float     @default(0)
  reviewCount Int       @default(0)
  latitude    Float?
  longitude   Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])
  
  ownerId     String?
  owner       User?     @relation(fields: [ownerId], references: [id])
  
  subscriptionTier String    @default("FREE") // FREE, PRO, ENTERPRISE
  subscriptionEnd  DateTime?
  
  // Freelance Specific Fields
  skills      String[]   @default([])
  languages   String[]   @default([])
  yearsOfExperience Int?
  hourlyRate  Float?
  currency    String     @default("EUR")
  available   Boolean    @default(true)

  // Verification Fields
  siret              String?
  linkedinUrl        String?
  verificationStatus VerificationStatus @default(PENDING)
  
  // Stripe Connect
  stripeAccountId          String?   @unique
  stripeOnboardingComplete Boolean   @default(false)

  whatsapp    String?
  viewCount   Int       @default(0)
  clickCount  Int       @default(0) // Website clicks
  contactCount Int      @default(0) // Phone/Whatsapp clicks

  reviews     Review[]
  media       Media[]
  promotions  Promotion[]
  services    Service[]
  bookings    Booking[]
  missionRequests MissionRequest[]
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  duration    Int?     // in minutes
  type        ServiceType @default(SERVICE)
  
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
  bookings    Booking[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Booking {
  id          String   @id @default(cuid())
  date        DateTime // Date and time of booking
  status      BookingStatus @default(PENDING)
  totalPrice  Float
  notes       String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  serviceId   String?
  service     Service? @relation(fields: [serviceId], references: [id])
  
  businessId  String
  business    Business @relation(fields: [businessId], references: [id]) 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Promotion {
  id          String   @id @default(cuid())
  title       String
  description String
  discount    String?
  startDate   DateTime @default(now())
  endDate     DateTime?
  active      Boolean  @default(true)
  
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
}

model Media {
  id          String   @id @default(cuid())
  url         String
  type        String   // "IMAGE" or "VIDEO"
  createdAt   DateTime @default(now())
  
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
}

model Category {
  id         String     @id @default(cuid())
  name       String     @unique
  slug       String     @unique
  businesses Business[]
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
  
  userId     String
  user       User     @relation(fields: [userId], references: [id])
}

enum ServiceType {
  SERVICE
  CLASS
  TICKET
  MENU_ITEM
  ROOM
  RESERVATION
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  PAID
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

// ==================== MISSION REQUEST SYSTEM ====================

model MissionRequest {
  id          String   @id @default(cuid())
  
  // Project Details
  title       String
  description String
  budget      Float?
  budgetType  BudgetType @default(FIXED)
  deadline    DateTime?
  duration    String?   // e.g., "2 weeks", "1 month"
  
  // Status & Workflow
  status      MissionStatus @default(PENDING)
  
  // Freelance Response
  freelanceMessage String?
  proposedPrice    Float?
  proposedDeadline DateTime?
  respondedAt      DateTime?
  
  // Client Info (for guest requests - no account needed)
  clientName   String
  clientEmail  String
  clientPhone  String?
  clientCompany String?
  
  // Optional relation to User (if client has account)
  clientId    String?
  client      User?    @relation("ClientMissions", fields: [clientId], references: [id])
  
  freelanceId String
  freelance   User     @relation("FreelanceMissions", fields: [freelanceId], references: [id])
  
  businessId  String
  business    Business @relation(fields: [businessId], references: [id])
  
  // Payment & Dispute
  payment     Payment?
  dispute     Dispute?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum MissionStatus {
  PENDING
  VIEWED
  PROPOSAL
  ACCEPTED     // Client accepted price/terms, waiting for payment
  IN_PROGRESS  // Payment secured (Held), work starts
  DELIVERED    // Freelance marked as done
  COMPLETED    // Client validated, funds released
  DISPUTED     // Problem reported
  CANCELLED
  REFUNDED     // Cancelled and money returned
}

enum BudgetType {
  FIXED
  HOURLY
  DAILY
  TO_DISCUSS
}

// ==================== PAYMENT SYSTEM ====================

model Payment {
  id                    String        @id @default(cuid())
  amount                Int           // Amount in cents (e.g. 1000 = 10.00â‚¬)
  currency              String        @default("eur")
  status                PaymentStatus @default(PENDING)
  
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?       @unique
  stripeTransferId      String?       @unique
  
  missionId             String        @unique
  mission               MissionRequest @relation(fields: [missionId], references: [id])
  
  payerId               String
  payer                 User          @relation("Payer", fields: [payerId], references: [id])
  
  recipientId           String        // The Business ID (freelancer)
  
  features              Json?         // Store platform fee data if we change commission later
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  heldAt                DateTime?
  releasedAt            DateTime?
}

enum PaymentStatus {
  PENDING
  REQUIRES_ACTION
  HELD              // Money is in Platform account, waiting for delivery
  RELEASED          // Money transferred to Freelancer Connected Account
  REFUNDED
  FAILED
}

model Dispute {
  id          String        @id @default(cuid())
  missionId   String        @unique
  mission     MissionRequest @relation(fields: [missionId], references: [id])
  
  openedById  String
  openedBy    User          @relation(fields: [openedById], references: [id])
  
  reason      String
  description String?
  status      DisputeStatus @default(OPEN)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  resolvedAt  DateTime?
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_REFUND
  RESOLVED_PAYOUT
}


