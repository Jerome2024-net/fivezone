generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String           @id @default(cuid())
  name                    String?
  email                   String           @unique
  password                String
  role                    String           @default("USER")
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  bookings                Booking[]
  businesses              Business[]
  disputesFounded         Dispute[]
  sentMissionRequests     MissionRequest[] @relation("ClientMissions")
  receivedMissionRequests MissionRequest[] @relation("FreelanceMissions")
  paymentsMade            Payment[]        @relation("Payer")
  reviews                 Review[]
}

model Business {
  id                       String             @id @default(cuid())
  name                     String
  description              String?
  address                  String
  city                     String
  country                  String             @default("France")
  phone                    String?
  website                  String?
  imageUrl                 String?
  rating                   Float              @default(0)
  reviewCount              Int                @default(0)
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  categoryId               String
  ownerId                  String?
  subscriptionTier         String             @default("FREE")
  subscriptionEnd          DateTime?
  whatsapp                 String?
  viewCount                Int                @default(0)
  clickCount               Int                @default(0)
  contactCount             Int                @default(0)
  coverUrl                 String?
  latitude                 Float?
  longitude                Float?
  hourlyRate               Float?
  skills                   String[]           @default([])
  linkedinUrl              String?
  siret                    String?
  verificationStatus       VerificationStatus @default(PENDING)
  currency                 String             @default("EUR")
  yearsOfExperience        Int?
  available                Boolean            @default(true)
  languages                String[]           @default([])
  stripeAccountId          String?            @unique
  stripeOnboardingComplete Boolean            @default(false)
  bookings                 Booking[]
  category                 Category           @relation(fields: [categoryId], references: [id])
  owner                    User?              @relation(fields: [ownerId], references: [id])
  media                    Media[]
  missionRequests          MissionRequest[]
  promotions               Promotion[]
  reviews                  Review[]
  services                 Service[]
}

model Service {
  id          String      @id @default(cuid())
  name        String
  description String?
  price       Float
  duration    Int?
  type        ServiceType @default(SERVICE)
  businessId  String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  bookings    Booking[]
  business    Business    @relation(fields: [businessId], references: [id])
}

model Booking {
  id         String        @id @default(cuid())
  date       DateTime
  status     BookingStatus @default(PENDING)
  totalPrice Float
  notes      String?
  userId     String
  serviceId  String?
  businessId String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  business   Business      @relation(fields: [businessId], references: [id])
  service    Service?      @relation(fields: [serviceId], references: [id])
  user       User          @relation(fields: [userId], references: [id])
}

model Promotion {
  id          String    @id @default(cuid())
  title       String
  description String
  discount    String?
  startDate   DateTime  @default(now())
  endDate     DateTime?
  active      Boolean   @default(true)
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id])
}

model Media {
  id         String   @id @default(cuid())
  url        String
  type       String
  createdAt  DateTime @default(now())
  businessId String
  business   Business @relation(fields: [businessId], references: [id])
}

model Category {
  id         String     @id @default(cuid())
  name       String     @unique
  slug       String     @unique
  businesses Business[]
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  businessId String
  userId     String
  business   Business @relation(fields: [businessId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model MissionRequest {
  id               String        @id @default(cuid())
  title            String
  description      String
  budget           Float?
  budgetType       BudgetType    @default(FIXED)
  deadline         DateTime?
  duration         String?
  status           MissionStatus @default(PENDING)
  freelanceMessage String?
  proposedPrice    Float?
  proposedDeadline DateTime?
  respondedAt      DateTime?
  clientId         String?
  freelanceId      String
  businessId       String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  clientCompany    String?
  clientEmail      String
  clientName       String
  clientPhone      String?
  dispute          Dispute?
  messages         Message[]
  business         Business      @relation(fields: [businessId], references: [id])
  client           User?         @relation("ClientMissions", fields: [clientId], references: [id])
  freelance        User          @relation("FreelanceMissions", fields: [freelanceId], references: [id])
  payment          Payment?
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  missionId String
  senderId  String
  mission   MissionRequest @relation(fields: [missionId], references: [id])
  sender    User     @relation(fields: [senderId], references: [id])
}

model Payment {
  id                    String         @id @default(cuid())
  amount                Int
  currency              String         @default("eur")
  status                PaymentStatus  @default(PENDING)
  stripePaymentIntentId String?        @unique
  stripeChargeId        String?        @unique
  stripeTransferId      String?        @unique
  missionId             String         @unique
  payerId               String
  recipientId           String
  features              Json?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  heldAt                DateTime?
  releasedAt            DateTime?
  mission               MissionRequest @relation(fields: [missionId], references: [id])
  payer                 User           @relation("Payer", fields: [payerId], references: [id])
}

model Dispute {
  id          String         @id @default(cuid())
  missionId   String         @unique
  openedById  String
  reason      String
  description String?
  status      DisputeStatus  @default(OPEN)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  resolvedAt  DateTime?
  mission     MissionRequest @relation(fields: [missionId], references: [id])
  openedBy    User           @relation(fields: [openedById], references: [id])
}

enum ServiceType {
  SERVICE
  CLASS
  TICKET
  MENU_ITEM
  ROOM
  RESERVATION
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  PAID
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum MissionStatus {
  PENDING
  VIEWED
  PROPOSAL
  ACCEPTED
  IN_PROGRESS
  DELIVERED
  COMPLETED
  DISPUTED
  CANCELLED
  REFUNDED
}

enum BudgetType {
  FIXED
  HOURLY
  DAILY
  TO_DISCUSS
}

enum PaymentStatus {
  PENDING
  REQUIRES_ACTION
  HELD
  RELEASED
  REFUNDED
  FAILED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_REFUND
  RESOLVED_PAYOUT
}
